<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pipeline TexasWin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
    .container { max-width: 1400px; margin: 0 auto; }
    .header { background: #002147; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; }
    .logout-btn { padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
    .login-box { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
    .login-box h2 { margin-bottom: 20px; }
    .form { display: flex; flex-direction: column; gap: 12px; }
    .input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .btn { padding: 12px; background: #002147; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .btn:hover { background: #001a33; }
    .content { display: flex; gap: 20px; padding: 20px; }
    .left-panel { width: 350px; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .right-panel { flex: 1; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .prospect-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
    .prospect-item:hover { background: #f9f9f9; }
    .prospect-item.active { background: #e8f4f8; border-left: 3px solid #002147; }
    .btn-new { background: #10a0dc; margin-bottom: 15px; }
    .btn-new:hover { background: #0885b8; }
    .error { color: #dc3545; margin: 10px 0; }
    .success { color: #28a745; margin: 10px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #f9f9f9; font-weight: bold; }
    .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 15px; }
    .detail-header h2 { margin: 0; }
    .detail-buttons { display: flex; gap: 10px; }
    .edit-btn { padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .delete-btn { padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
    textarea { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; min-height: 80px; }
    .empty-state { text-align: center; color: #999; padding: 40px; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const API_URL = 'https://pipeline-app-702707858708.europe-west9.run.app';

    function App() {
      const [user, setUser] = React.useState(null);
      const [prospects, setProspects] = React.useState([]);
      const [selectedProspect, setSelectedProspect] = React.useState(null);
      const [showForm, setShowForm] = React.useState(false);
      const [formData, setFormData] = React.useState({
        name: '', contact_name: '', email: '', phone: '', status: 'Prospection',
        setup_amount: 0, monthly_amount: 0, annual_amount: 0, training_amount: 0,
        chance_percent: 20, assigned_to: '', quote_date: '', decision_maker: '', notes: ''
      });

      React.useEffect(() => {
        if (user) fetchProspects();
      }, [user]);

      const fetchProspects = async () => {
        try {
          const res = await fetch(`${API_URL}/api/prospects`, {
            headers: { 'Authorization': `Bearer ${user.token}` }
          });
          if (res.ok) {
            const data = await res.json();
            setProspects(data || []);
          }
        } catch (err) {
          console.error('Erreur:', err);
        }
      };

      const handleLogin = async (email, password, name, isRegister) => {
        try {
          const endpoint = isRegister ? 'register' : 'login';
          const payload = isRegister ? { email, password, name } : { email, password };
          
          const res = await fetch(`${API_URL}/api/auth/${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          const data = await res.json();
          if (data.token) {
            setUser({ ...data.user, token: data.token });
          } else {
            alert('Erreur: ' + data.error);
          }
        } catch (err) {
          alert('Erreur connexion: ' + err.message);
        }
      };

      const handleSaveProspect = async () => {
        if (!formData.name) {
          alert('Le nom est requis');
          return;
        }

        try {
          const method = formData.id ? 'PUT' : 'POST';
          const url = formData.id ? `${API_URL}/api/prospects/${formData.id}` : `${API_URL}/api/prospects`;

          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${user.token}` },
            body: JSON.stringify(formData)
          });

          if (res.ok) {
            await fetchProspects();
            setShowForm(false);
            setFormData({ name: '', contact_name: '', email: '', phone: '', status: 'Prospection',
              setup_amount: 0, monthly_amount: 0, annual_amount: 0, training_amount: 0,
              chance_percent: 20, assigned_to: '', quote_date: '', decision_maker: '', notes: '' });
          }
        } catch (err) {
          alert('Erreur: ' + err.message);
        }
      };

      const handleDeleteProspect = async (id) => {
        if (window.confirm('Supprimer?')) {
          try {
            const res = await fetch(`${API_URL}/api/prospects/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${user.token}` }
            });
            if (res.ok) {
              fetchProspects();
              setSelectedProspect(null);
            }
          } catch (err) {
            alert('Erreur: ' + err.message);
          }
        }
      };

      if (!user) {
        return <LoginForm onLogin={handleLogin} />;
      }

      return (
        <div>
          <div className="header">
            <h1>Pipeline TexasWin</h1>
            <div>
              <span style={{marginRight: '15px'}}>{user.name}</span>
              <button className="logout-btn" onClick={() => setUser(null)}>Déconnexion</button>
            </div>
          </div>

          <div className="container">
            <div className="content">
              <div className="left-panel">
                <button className="btn btn-new" onClick={() => {
                  setShowForm(true);
                  setFormData({ name: '', contact_name: '', email: '', phone: '', status: 'Prospection',
                    setup_amount: 0, monthly_amount: 0, annual_amount: 0, training_amount: 0,
                    chance_percent: 20, assigned_to: '', quote_date: '', decision_maker: '', notes: '' });
                }}>+ Nouveau prospect</button>

                <div style={{overflowY: 'auto', maxHeight: 'calc(100vh - 180px)'}}>
                  {prospects.map(p => (
                    <div key={p.id} className={`prospect-item ${selectedProspect?.id === p.id ? 'active' : ''}`}
                      onClick={() => setSelectedProspect(p)}>
                      <strong>{p.name}</strong><br/>
                      <small>{p.contact_name}</small><br/>
                      <small style={{color: '#0066cc'}}>{p.status}</small>
                    </div>
                  ))}
                </div>
              </div>

              <div className="right-panel">
                {showForm ? (
                  <ProspectForm formData={formData} onFormChange={setFormData} onSave={handleSaveProspect}
                    onCancel={() => setShowForm(false)} />
                ) : selectedProspect ? (
                  <div>
                    <div className="detail-header">
                      <h2>{selectedProspect.name}</h2>
                      <div className="detail-buttons">
                        <button className="edit-btn" onClick={() => {
                          setFormData(selectedProspect);
                          setShowForm(true);
                        }}>Modifier</button>
                        <button className="delete-btn" onClick={() => handleDeleteProspect(selectedProspect.id)}>Supprimer</button>
                      </div>
                    </div>

                    <table>
                      <tbody>
                        <tr><td><strong>Contact</strong></td><td>{selectedProspect.contact_name}</td></tr>
                        <tr><td><strong>Email</strong></td><td>{selectedProspect.email}</td></tr>
                        <tr><td><strong>Tél</strong></td><td>{selectedProspect.phone}</td></tr>
                        <tr><td><strong>Statut</strong></td><td>{selectedProspect.status}</td></tr>
                        <tr><td><strong>Commercial</strong></td><td>{selectedProspect.assigned_to}</td></tr>
                        <tr><td><strong>Setup</strong></td><td>{selectedProspect.setup_amount}€</td></tr>
                        <tr><td><strong>Abonnement (mois)</strong></td><td>{selectedProspect.monthly_amount}€</td></tr>
                        <tr><td><strong>Abonnement (an)</strong></td><td>{selectedProspect.annual_amount}€</td></tr>
                        <tr><td><strong>Formation</strong></td><td>{selectedProspect.training_amount}€</td></tr>
                        <tr><td><strong>Probabilité</strong></td><td>{selectedProspect.chance_percent}%</td></tr>
                        <tr><td><strong>Notes</strong></td><td>{selectedProspect.notes}</td></tr>
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <div className="empty-state">Sélectionnez un prospect</div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    function LoginForm({ onLogin }) {
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [name, setName] = React.useState('');
      const [isRegister, setIsRegister] = React.useState(false);

      const handleSubmit = (e) => {
        e.preventDefault();
        onLogin(email, password, name, isRegister);
      };

      return (
        <div className="login-container">
          <div className="login-box">
            <h2>Pipeline TexasWin</h2>
            <form onSubmit={handleSubmit} className="form">
              {isRegister && (
                <input type="text" placeholder="Nom complet" value={name} onChange={(e) => setName(e.target.value)} className="input" required />
              )}
              <input type="email" placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} className="input" required />
              <input type="password" placeholder="Mot de passe" value={password} onChange={(e) => setPassword(e.target.value)} className="input" required />
              <button type="submit" className="btn">{isRegister ? "S'inscrire" : "Se connecter"}</button>
            </form>
            <p style={{marginTop: '15px', textAlign: 'center', fontSize: '13px', color: '#666'}}>
              {isRegister ? 'Déjà inscrit?' : 'Pas encore inscrit?'}{' '}
              <a href="#" onClick={(e) => { e.preventDefault(); setIsRegister(!isRegister); }} style={{color: '#0066cc'}}>
                {isRegister ? 'Se connecter' : "S'inscrire"}
              </a>
            </p>
          </div>
        </div>
      );
    }

    function ProspectForm({ formData, onFormChange, onSave, onCancel }) {
      const handleChange = (field, value) => {
        onFormChange({ ...formData, [field]: value });
      };

      return (
        <div>
          <h2>{formData.id ? 'Modifier' : 'Nouveau'} prospect</h2>
          <div className="form-grid">
            <input type="text" placeholder="Nom" value={formData.name} onChange={(e) => handleChange('name', e.target.value)} className="input" />
            <input type="text" placeholder="Contact" value={formData.contact_name} onChange={(e) => handleChange('contact_name', e.target.value)} className="input" />
            <input type="email" placeholder="Email" value={formData.email} onChange={(e) => handleChange('email', e.target.value)} className="input" />
            <input type="tel" placeholder="Tél" value={formData.phone} onChange={(e) => handleChange('phone', e.target.value)} className="input" />
            <select value={formData.status} onChange={(e) => handleChange('status', e.target.value)} className="input">
              <option>Prospection</option>
              <option>Devis</option>
              <option>Démo</option>
              <option>Négociation</option>
              <option>Signé</option>
              <option>Perdu</option>
            </select>
            <select value={formData.assigned_to} onChange={(e) => handleChange('assigned_to', e.target.value)} className="input">
              <option value="">-- Commercial --</option>
              <option>Roger</option>
              <option>Christian</option>
              <option>Frédéric</option>
            </select>
            <input type="number" placeholder="Setup" value={formData.setup_amount} onChange={(e) => handleChange('setup_amount', e.target.value)} className="input" />
            <input type="number" placeholder="Abonnement (mois)" value={formData.monthly_amount} onChange={(e) => handleChange('monthly_amount', e.target.value)} className="input" />
            <input type="number" placeholder="Abonnement (an)" value={formData.annual_amount} onChange={(e) => handleChange('annual_amount', e.target.value)} className="input" />
            <input type="number" placeholder="Formation" value={formData.training_amount} onChange={(e) => handleChange('training_amount', e.target.value)} className="input" />
            <select value={formData.chance_percent} onChange={(e) => handleChange('chance_percent', e.target.value)} className="input">
              <option value="20">20%</option>
              <option value="40">40%</option>
              <option value="60">60%</option>
              <option value="80">80%</option>
              <option value="100">100%</option>
            </select>
            <input type="date" value={formData.quote_date} onChange={(e) => handleChange('quote_date', e.target.value)} className="input" />
          </div>
          <textarea placeholder="Notes" value={formData.notes} onChange={(e) => handleChange('notes', e.target.value)} />
          <div style={{display: 'flex', gap: '10px', marginTop: '15px'}}>
            <button className="btn" onClick={onSave} style={{flex: 1}}>Enregistrer</button>
            <button className="btn" onClick={onCancel} style={{flex: 1, background: '#6c757d'}}>Annuler</button>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('app'));
    root.render(<App />);
  </script>
</body>
</html>
